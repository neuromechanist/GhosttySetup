#!/bin/bash
# Theme watcher for Ghostty - updates cursor and split colors based on system appearance

set -e

CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
CACHE_FILE="$HOME/.cache/ghostty-theme-watcher/current-theme"

# Ensure cache directory exists
mkdir -p "$(dirname "$CACHE_FILE")"

# Detect current macOS appearance
get_appearance() {
    if defaults read -g AppleInterfaceStyle &>/dev/null; then
        echo "dark"
    else
        echo "light"
    fi
}

# Update config file with theme-aware colors
update_config() {
    local appearance=$1
    local divider_color
    local fill_color
    local cursor_color
    local cursor_text_color

    if [ "$appearance" = "dark" ]; then
        divider_color="#f0f0f0"      # White for dark mode
        fill_color="#f0f0f0"
        cursor_color="#f0f0f0"       # Light cursor on dark background
        cursor_text_color="#0f0f0f"  # Dark text under cursor
    else
        divider_color="#0f0f0f"      # Black for light mode
        fill_color="#0f0f0f"
        cursor_color="#0f0f0f"       # Dark cursor on light background
        cursor_text_color="#f0f0f0"  # Light text under cursor
    fi

    # Update cursor-color
    if grep -q "^cursor-color" "$CONFIG_FILE"; then
        sed -i '' "s|^cursor-color.*|cursor-color = $cursor_color|" "$CONFIG_FILE"
    else
        echo "cursor-color = $cursor_color" >> "$CONFIG_FILE"
    fi

    # Update cursor-text
    if grep -q "^cursor-text" "$CONFIG_FILE"; then
        sed -i '' "s|^cursor-text.*|cursor-text = $cursor_text_color|" "$CONFIG_FILE"
    else
        echo "cursor-text = $cursor_text_color" >> "$CONFIG_FILE"
    fi

    # Update split-divider-color
    if grep -q "^split-divider-color" "$CONFIG_FILE"; then
        sed -i '' "s|^split-divider-color.*|split-divider-color = $divider_color|" "$CONFIG_FILE"
    else
        echo "split-divider-color = $divider_color" >> "$CONFIG_FILE"
    fi

    # Update unfocused-split-fill
    if grep -q "^unfocused-split-fill" "$CONFIG_FILE"; then
        sed -i '' "s|^unfocused-split-fill.*|unfocused-split-fill = $fill_color|" "$CONFIG_FILE"
    else
        echo "unfocused-split-fill = $fill_color" >> "$CONFIG_FILE"
    fi
}

# Main loop
echo "Starting Ghostty theme watcher..."
echo "Config will be updated automatically. Restart Ghostty (Cmd+Q, reopen) to apply changes."

# Initial update
current_appearance=$(get_appearance)
echo "$current_appearance" > "$CACHE_FILE"
update_config "$current_appearance"
echo "Initial theme: $current_appearance"

# Watch for changes
while true; do
    sleep 2

    new_appearance=$(get_appearance)

    if [ "$new_appearance" != "$current_appearance" ]; then
        echo "Appearance changed: $current_appearance -> $new_appearance"
        current_appearance=$new_appearance
        echo "$current_appearance" > "$CACHE_FILE"

        update_config "$current_appearance"

        echo "Config updated! Restart Ghostty to apply changes."
    fi
done
