#!/bin/bash
# Theme watcher for Ghostty - updates cursor and split colors based on system appearance

set -e

CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
CACHE_FILE="$HOME/.cache/ghostty-theme-watcher/current-theme"

# Ensure cache directory exists
mkdir -p "$(dirname "$CACHE_FILE")"

# Detect current macOS appearance
get_appearance() {
    if defaults read -g AppleInterfaceStyle &>/dev/null; then
        echo "dark"
    else
        echo "light"
    fi
}

# Set a single config value, appending if not present
set_config_value() {
    local key=$1
    local value=$2
    if grep -q "^${key} = " "$CONFIG_FILE"; then
        sed -i '' "s|^${key} = .*|${key} = ${value}|" "$CONFIG_FILE"
    else
        echo "${key} = ${value}" >> "$CONFIG_FILE"
    fi
}

# Update config file with theme-aware colors
update_config() {
    local appearance=$1
    local fg_color bg_color

    if [ "$appearance" = "dark" ]; then
        fg_color="#f0f0f0"  # Light foreground on dark background
        bg_color="#0f0f0f"
    else
        fg_color="#0f0f0f"  # Dark foreground on light background
        bg_color="#f0f0f0"
    fi

    if [ ! -f "$CONFIG_FILE" ]; then
        echo "Config file not found: $CONFIG_FILE"
        return 1
    fi

    set_config_value "cursor-color" "$fg_color"
    set_config_value "cursor-text" "$bg_color"
    set_config_value "split-divider-color" "$fg_color"
    set_config_value "unfocused-split-fill" "$fg_color"
}

# Main loop
echo "Starting Ghostty theme watcher..."
echo "Config will be updated automatically. Restart Ghostty (Cmd+Q, reopen) to apply changes."

# Initial update
current_appearance=$(get_appearance)
echo "$current_appearance" > "$CACHE_FILE"
update_config "$current_appearance"
echo "Initial theme: $current_appearance"

# Watch for changes
while true; do
    sleep 2

    new_appearance=$(get_appearance)

    if [ "$new_appearance" != "$current_appearance" ]; then
        echo "Appearance changed: $current_appearance -> $new_appearance"
        current_appearance=$new_appearance
        echo "$current_appearance" > "$CACHE_FILE"

        update_config "$current_appearance"

        echo "Config updated! Restart Ghostty to apply changes."
    fi
done
